package cn.zwz.xboot.modules.tricycle.controller;

import cn.zwz.xboot.common.utils.PageUtil;
import cn.zwz.xboot.common.utils.ResultUtil;
import cn.zwz.xboot.common.vo.PageVo;
import cn.zwz.xboot.common.vo.Result;
import cn.zwz.xboot.modules.tricycle.entity.*;
import cn.zwz.xboot.modules.tricycle.service.*;
import cn.zwz.xboot.modules.utils.DateUtils;
import cn.zwz.xboot.modules.utils.NullUtils;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModelProperty;
import io.swagger.annotations.ApiOperation;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import org.springframework.web.multipart.MultipartHttpServletRequest;
import org.springframework.web.servlet.ModelAndView;

/**
 * @author 郑为中
 */
@Slf4j
@RestController
@Api(description = "车辆管理接口")
@RequestMapping("/xboot/car")
@Transactional
public class CarController {

    @Autowired
    private ICarService iCarService;

    @Autowired
    private ISellerService iSellerService;

    @Autowired
    private IUpdateRecordService iUpdateRecordService;

    @Autowired
    private IAdminLookArchService iAdminLookArchService;

    @Autowired
    private IShMsgService iShMsgService;

    @RequestMapping(value = "/getCarDataBySellId", method = RequestMethod.POST)
    @ApiOperation(value = "根据卖家获取已售车辆信息")
    public Result<List<Car>> appUpdate(@RequestParam String id){
        QueryWrapper<Car> qw = new QueryWrapper<>();
        qw.eq("seller_id",id);
        List<Car> carList = iCarService.list(qw);
        return new ResultUtil<List<Car>>().setData(carList);
    }

    @RequestMapping(value = "/appAddCar", method = RequestMethod.POST)
    @ApiOperation(value = "小程序加车")
    public Result<String> appUpdate(@RequestParam String sellDate,@RequestParam String jia,@RequestParam String gu,@RequestParam String pinPai,@RequestParam String xingHao,@RequestParam String type,@RequestParam String sellerId,
                                    @RequestParam String ownerName,@RequestParam String ownerMobile,@RequestParam String ownerIdcard,@RequestParam String ownerAddress1,@RequestParam String ownerAddress2,
                                    @RequestParam String re1,@RequestParam String re2){
        Car car = new Car();
        car.setSellDate(sellDate);
        car.setJia(jia);
        car.setGu(gu);
        car.setPinPai(pinPai);
        car.setXingHao(xingHao);
        car.setType(type);
        car.setRe1(re1);
        car.setRe2(re2);
        car.setName(ownerName);
        car.setMobile(ownerMobile);
        car.setOwnerIdcard(ownerIdcard);
        car.setAddressHu(ownerAddress1);
        car.setAddressZhu(ownerAddress2);
        car.setSh("0");
        QueryWrapper<Car> qw = new QueryWrapper<>();
        qw.orderByDesc("file_id");
        List<Car> carList = iCarService.list(qw);
        int newId = 0;
        if(carList == null || carList.size() == 0) {
            newId = 0;
        }else {
            newId = carList.get(0).getFileId() + 1;
        }
        car.setFileId(newId);
        Seller seller = iSellerService.getById(sellerId);
        if(seller != null) {
            car.setSellerId(sellerId);
            car.setSellerName(seller.getShopName());
            iCarService.saveOrUpdate(car);
            ShMsg shMsg = new ShMsg();
            shMsg.setDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
            shMsg.setMsg("");
            shMsg.setStatus("尚未审核");
            shMsg.setType("车辆新增审核");
            shMsg.setFormId(car.getId());
            shMsg.setSellerId(seller.getId());
            shMsg.setName(car.getType() + " - " + car.getXingHao());
            iShMsgService.saveOrUpdate(shMsg);
            return new ResultUtil<String>().setData(car.getId());
        }
        return new ResultUtil<String>().setErrorMsg("FAIL");
    }

    @RequestMapping(value = "/getByNotSh", method = RequestMethod.GET)
    public Result<List<Car>> getByPageNotSh(){
        QueryWrapper<Car> qw = new QueryWrapper<>();
        qw.eq("sh","0");
        List<Car> data = iCarService.list(qw);
        return new ResultUtil<List<Car>>().setData(data);
    }

    @RequestMapping(value = "/sh", method = RequestMethod.POST)
    @ApiOperation(value = "获取全部数据")
    public Result<List<Car>> sh(@RequestParam String id,@RequestParam String msg,@RequestParam(required = false) String msg2){
        Car car = iCarService.getById(id);
        if(car != null) {
            QueryWrapper<ShMsg> qw = new QueryWrapper<>();
            qw.like("type","车辆");
            qw.eq("form_id",car.getId());
            qw.orderByDesc("create_time");
            List<ShMsg> list = iShMsgService.list(qw);
            if(msg.equals("OK")) {
                car.setSh("1");
                if(list.size() > 0) {
                    if(msg2 == null && !NullUtils.isNull(msg2)) {
                        list.get(0).setMsg("审核通过");
                    }else {
                        list.get(0).setMsg(msg2);
                    }
                    list.get(0).setStatus("已通过");
                    list.get(0).setDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
                }
            } else {
                car.setSh("2");
                if(list.size() > 0) {
                    list.get(0).setStatus("未通过");
                    list.get(0).setMsg(msg);
                    list.get(0).setDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
                }
            }
            iCarService.saveOrUpdate(car);
            if(list.size() > 0) {
                iShMsgService.saveOrUpdate(list.get(0));
            }
            return new ResultUtil<List<Car>>().setSuccessMsg("OK");
        }
        return new ResultUtil<List<Car>>().setErrorMsg("FAIL");
    }

    @RequestMapping(value = "/appUpdateCar", method = RequestMethod.POST)
    @ApiOperation(value = "小程序改车")
    public Result<String> appUpdateCar(@RequestParam String id,@RequestParam String sellDate,@RequestParam String jia,@RequestParam String gu,@RequestParam String pinPai,@RequestParam String xingHao,@RequestParam String type,
                                    @RequestParam String ownerName,@RequestParam String ownerMobile,@RequestParam String ownerIdcard,@RequestParam String ownerAddress1,@RequestParam String ownerAddress2,
                                       @RequestParam String re1,@RequestParam String re2,@RequestParam String sellerId){

        Car car = iCarService.getById(id);
        if(car == null) {
            return new ResultUtil<String>().setErrorMsg("FAIL");
        }
        car.setSh("0");
        car.setSellDate(sellDate);
        car.setJia(jia);
        car.setGu(gu);
        car.setPinPai(pinPai);
        car.setXingHao(xingHao);
        car.setType(type);
        car.setOwnerIdcard(ownerIdcard);
        car.setName(ownerName);
        car.setMobile(ownerMobile);
        car.setAddressHu(ownerAddress1);
        car.setAddressZhu(ownerAddress2);
        car.setRe1(re1);
        car.setRe2(re2);
        iCarService.saveOrUpdate(car);
        QueryWrapper<ShMsg> qww = new QueryWrapper<>();
        qww.like("type","车辆");
        qww.eq("form_id",car.getId());
        qww.eq("status","尚未审核");
        qww.eq("seller_id",sellerId);
        iShMsgService.remove(qww);
        ShMsg shMsg = new ShMsg();
        shMsg.setDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
        shMsg.setMsg("");
        shMsg.setStatus("尚未审核");
        shMsg.setType("车辆修改审核");
        shMsg.setFormId(car.getId());
        shMsg.setName(car.getType() + " - " + car.getXingHao());
        shMsg.setSellerId(sellerId);
        iShMsgService.saveOrUpdate(shMsg);
        return new ResultUtil<String>().setSuccessMsg("提交成功");


//        // 去重
//        QueryWrapper<UpdateRecord> qw = new QueryWrapper<>();
//        qw.eq("old_id",id);
//        qw.eq("look_flag","0");
//        List<UpdateRecord> oldList = iUpdateRecordService.list(qw);
//        for (UpdateRecord updateRecord : oldList) {
//            iUpdateRecordService.removeById(updateRecord.getId());
//        }
//
//        UpdateRecord ur = new UpdateRecord();
//        ur.setOldId(id);
//        ur.setSellDate(car.getSellDate());
//        ur.setJia(car.getJia());
//        ur.setGu(car.getGu());
//        ur.setPinPai(car.getPinPai());
//        ur.setXingHao(car.getXingHao());
//        ur.setType(car.getType());
//        ur.setName(car.getName());
//        ur.setMobile(car.getMobile());
//        ur.setOwnerIdcard(car.getOwnerIdcard());
//        ur.setAddressHu(car.getAddressHu());
//        ur.setAddressZhu(car.getAddressZhu());
//        ur.setRe1(car.getRe1());
//        ur.setRe2(car.getRe2());
//
//        ur.setSellDate1(sellDate);
//        ur.setJia1(jia);
//        ur.setGu1(gu);
//        ur.setPinPai1(pinPai);
//        ur.setXingHao1(xingHao);
//        ur.setType1(type);
//        ur.setName1(ownerName);
//        ur.setMobile1(ownerMobile);
//        ur.setOwnerIdcard1(ownerIdcard);
//        ur.setAddressHu1(ownerAddress1);
//        ur.setAddressZhu1(ownerAddress2);
//        ur.setRe11(re1);
//        ur.setRe21(re2);
//
//        ur.setLookFlag("0");
//        ur.setLookPeople("未审核");
//        ur.setSellerId(sellerId);
//        ur.setSellerName(seller.getShopName());
//        ur.setSendDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
//        iUpdateRecordService.save(ur);
    }

    @RequestMapping(value = "/uploadFaPiaoImages", method = { RequestMethod.POST,RequestMethod.GET})
    public ModelAndView uploadImage(HttpServletRequest request, HttpServletResponse response) throws IOException {
        MultipartHttpServletRequest req =(MultipartHttpServletRequest)request;
        MultipartFile file =  req.getFile("file");
        String carId = (String)request.getParameter("id");
//        carId = carId.substring(2, carId.length()-2); //手动解析JSON数据 去外部双引号
        if(file != null){
            System.out.println("获取图片成功");
        }
        String realPath = "C:\\java\\tomcat\\webapps\\docs\\static\\";
        System.out.println(realPath);
        try {
            File dir = new File(realPath);
            if (!dir.exists()) {
                dir.mkdir();
            }
            String uuid = UUID.randomUUID().toString().replaceAll("-","");
//            uuid = uuid.substring(20,uuid.length() - 1);
            System.out.println(uuid);
            String name =uuid + ".jpg";
            System.out.println(name);
            Car car = iCarService.getById(carId);
            if(car != null) {
                car.setPiaoPhoto(name);
                iCarService.saveOrUpdate(car);
            }
            java.io.File files  =  new File(realPath, name); // ".jpg"
            file.transferTo(files);
            byte[] data = null;
            // 读取图片字节数组
            try {
                InputStream in = new FileInputStream(realPath+name);
                data = new byte[in.available()];
                in.read(data);
                in.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        } catch (IOException e) {
            e.printStackTrace();
        } catch (IllegalStateException e) {
            e.printStackTrace();
        }
        return null;
    }


    @RequestMapping(value = "/get", method = RequestMethod.GET)
    @ApiOperation(value = "通过id获取")
    public Result<Car> get(@RequestParam String id){
        Car car = iCarService.getById(id);
        return new ResultUtil<Car>().setData(car);
    }

    @RequestMapping(value = "/getByOpenId", method = RequestMethod.GET)
    @ApiOperation(value = "通过id获取")
    public Result<Car> getByOpenId(@RequestParam String id,@RequestParam String openId){
        QueryWrapper<AdminLookArch> qw = new QueryWrapper<>();
        qw.eq("open_id",openId);
        List<AdminLookArch> adminLookArchList = iAdminLookArchService.list(qw);
        if(adminLookArchList.size() == 0) {
            return new ResultUtil<Car>().setData(null);
        }
        QueryWrapper<Car> qww = new QueryWrapper<>();
        qww.eq("file_id",id);
        List<Car> list = iCarService.list(qww);
        return new ResultUtil<Car>().setData(list.size() == 0 ? null : list.get(0));
    }

    /**
     * 买家列表
     * @return
     */
    @RequestMapping(value = "/getAllOwner", method = RequestMethod.GET)
    @ApiOperation(value = "通过id获取")
    public Result<List<Owner>> getAllOwner(@RequestParam(required = false) int pageNumber,@RequestParam(required = false) int pageSize){
        if(pageNumber == 0) pageNumber = 1;
        if(pageSize == 0) pageSize = 10;
        List<String> idCardListAll = iCarService.getAllIdCardList();

        // 手动分页
        List<String> idCardList = new ArrayList<>();
        for(int i = (pageNumber - 1) * pageSize ; i < pageNumber * pageSize && i < idCardListAll.size() ; i ++ ) {
            idCardList.add(idCardListAll.get(i));
        }

        QueryWrapper<Car> qw = new QueryWrapper<>();
        qw.eq("sh","1");
        qw.ne("remark","虚拟车辆");
        List<Car> carList = iCarService.list(qw);
        List<Car> carList2 = iCarService.list();
        List<Owner> ans = new ArrayList<>();

        for (String idCard : idCardList) {
            Owner owner = new Owner();
            List<Car> tempCarList = new ArrayList<>();
            List<Car> tempCarList2 = new ArrayList<>(); // 包括虚拟车辆
            for (Car car : carList) {
                if(car.getOwnerIdcard().equals(idCard)) {
                    tempCarList.add(car);
                }
            }
            for (Car car : carList2) {
                if(car.getOwnerIdcard().equals(idCard)) {
                    tempCarList2.add(car);
                }
            }
            owner.setCarList(tempCarList);
            owner.setOwnerIdcard(idCard);
            if(tempCarList2.size() > 0) {
                Car car = tempCarList2.get(tempCarList2.size() - 1);
                owner.setRe1(car.getRe1());
                owner.setRe2(car.getRe2());
                owner.setAddressHu(car.getAddressHu());
                owner.setAddressZhu(car.getAddressZhu());
                owner.setJiaNumber(car.getJiaNumber());
                owner.setMobile(car.getMobile());
                owner.setName(car.getName());
            }
            ans.add(owner);
        }
        return new ResultUtil<List<Owner>>().setData(ans);
    }

    @Data
    private static class Owner {
        @ApiModelProperty(value = "姓名")
        private String name;

        @ApiModelProperty(value = "手机号")
        private String mobile;

        @ApiModelProperty(value = "身份证号")
        private String ownerIdcard;

        @ApiModelProperty(value = "户籍地址")
        private String addressHu;

        @ApiModelProperty(value = "住址")
        private String addressZhu;

        @ApiModelProperty(value = "户籍地址")
        private String re1;

        @ApiModelProperty(value = "户籍地址")
        private String re2;

        @ApiModelProperty(value = "是否有驾照")
        private String isJia;

        @ApiModelProperty(value = "驾照号码")
        private String jiaNumber;

        private List<Car> carList;
    }

    @RequestMapping(value = "/getAll", method = RequestMethod.GET)
    @ApiOperation(value = "获取全部数据")
    public Result<List<Car>> getAll(){

        List<Car> list = iCarService.list();
        return new ResultUtil<List<Car>>().setData(list);
    }

    @RequestMapping(value = "/getByPage", method = RequestMethod.GET)
    @ApiOperation(value = "分页获取")
    public Result<IPage<Car>> getByPage(@ModelAttribute Car car,@ModelAttribute PageVo page){
        QueryWrapper<Car> qw = new QueryWrapper<>();
        if(car.getOwnerIdcard() != null && !NullUtils.isNull(car.getOwnerIdcard())) {
            qw.eq("owner_idcard",car.getOwnerIdcard());
        }
        if(car.getBaoXian() != null && !NullUtils.isNull(car.getBaoXian())) {
            qw.like("bao_xian",car.getBaoXian());
        }
        if(car.getXingHao() != null && !NullUtils.isNull(car.getXingHao())) {
            qw.like("xing_hao",car.getXingHao());
        }
        if(car.getGu() != null && !NullUtils.isNull(car.getGu())) {
            qw.like("gu",car.getGu());
        }
        if(car.getJia() != null && !NullUtils.isNull(car.getJia())) {
            qw.like("jia",car.getJia());
        }
        if(car.getPaiHao() != null && !NullUtils.isNull(car.getPaiHao())) {
            qw.like("pai_hao",car.getPaiHao());
        }
        if(car.getPinPai() != null && !NullUtils.isNull(car.getPinPai())) {
            qw.like("pin_pai",car.getPinPai());
        }
        if(car.getRemark() != null && !NullUtils.isNull(car.getRemark())) {
            qw.like("remark",car.getRemark());
        }
        if(car.getSellDate() != null && !NullUtils.isNull(car.getSellDate())) {
            qw.eq("sell_date",car.getSellDate());
        }
        if(car.getType() != null && !NullUtils.isNull(car.getType())) {
            qw.like("type",car.getType());
        }
        if(car.getName() != null && !NullUtils.isNull(car.getName())) {
            qw.like("name",car.getName());
        }
        if(car.getSellerName() != null && !NullUtils.isNull(car.getSellerName())) {
            qw.like("seller_name",car.getSellerName());
        }
        IPage<Car> data = iCarService.page(PageUtil.initMpPage(page),qw);
        return new ResultUtil<IPage<Car>>().setData(data);
    }

    @RequestMapping(value = "/insertOrUpdate", method = RequestMethod.POST)
    @ApiOperation(value = "编辑或更新数据")
    public Result<Car> saveOrUpdate(Car car){

        if(iCarService.saveOrUpdate(car)){
            return new ResultUtil<Car>().setData(car);
        }
        return new ResultUtil<Car>().setErrorMsg("操作失败");
    }

    @RequestMapping(value = "/delByIds", method = RequestMethod.POST)
    @ApiOperation(value = "批量通过id删除")
    public Result<Object> delAllByIds(@RequestParam String[] ids){

        for(String id : ids){
            iCarService.removeById(id);
        }
        return ResultUtil.success("批量通过id删除数据成功");
    }

    @RequestMapping(value = "/uploadPhoto", method = RequestMethod.POST)
    @ApiOperation(value = "文件上传")
    public Result<String> upload(@RequestParam(required = false) MultipartFile file) {
        if(file == null){
            return ResultUtil.error("文件不存在");
        }
        final String realPaths = "C:\\java\\tomcat\\webapps\\docs\\static\\";
        try {
            java.io.File dir = new File(realPaths);
            if (!dir.exists()) {
                dir.mkdir();
            }
            System.out.println(file.getOriginalFilename().substring(0,file.getOriginalFilename().lastIndexOf(".") ));
            String uuid = UUID.randomUUID().toString().replaceAll("-","");
//            uuid = uuid.substring(20,uuid.length() - 1);
            System.out.println(uuid);
            String name =uuid + "." + file.getOriginalFilename();
            java.io.File files  =  new File(realPaths, name); // ".jpg"
            files.setReadable(true);
            files.setExecutable(true);
            files.setWritable(true);
            file.transferTo(files);
            byte[] data = null;
            // 读取图片字节数组
            try {
                InputStream in = new FileInputStream(realPaths+name);
                data = new byte[in.available()];
                in.read(data);
                in.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
            return new ResultUtil<String>().setData(name);
        } catch (IOException e) {
            e.printStackTrace();
        } catch (IllegalStateException e) {
            e.printStackTrace();
        }
        return ResultUtil.error("FAIL");
    }

    @RequestMapping(value = "/appDelete", method = RequestMethod.POST)
    @ApiOperation(value = "批量通过id删除")
    public Result<Object> appDelete(@RequestParam String id,@RequestParam String sellerId){

        Car car = iCarService.getById(id);
        if(car == null) {
            return ResultUtil.error("不存在");
        }
        Seller seller = iSellerService.getById(sellerId);
        if(seller == null) {
            return ResultUtil.error("不存在");
        }
        iCarService.removeById(car.getId());
//        UpdateRecord ur = new UpdateRecord();
//        ur.setSellDate1(car.getSellDate());
//        ur.setJia1(car.getJia());
//        ur.setGu1(car.getGu());
//        ur.setPinPai1(car.getPinPai());
//        ur.setXingHao1(car.getXingHao());
//        ur.setType1(car.getType());
//        ur.setName1(car.getName());
//        ur.setMobile1(car.getMobile());
//        ur.setOwnerIdcard1(car.getOwnerIdcard());
//        ur.setAddressHu1(car.getAddressHu());
//        ur.setAddressZhu1(car.getAddressZhu());
//        ur.setRe11(car.getRe1());
//        ur.setRe21(car.getRe2());
//        ur.setLookFlag("5");
//        ur.setLookPeople("未审核");
//        ur.setSellerId(sellerId);
//        ur.setSellerName(seller.getShopName());
//        ur.setSendDate(DateUtils.getCompleteNowDate() + " " + DateUtils.getNowTime());
//        iUpdateRecordService.save(ur);
        return ResultUtil.success("OK");
    }
}
